<script type="module">
  // ====== Supabase åˆå§‹åŒ– ======
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // !!! æŒ‰ä½ çš„å®é™…å€¼å¡«å†™ï¼ˆä¸‹é¢ç”¨çš„æ˜¯ä½ ç°åœ¨é¡¹ç›®çš„å€¼ï¼‰
  const SUPABASE_URL = 'https://ozxwxzafxxkedrotzqmu.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96eHd4emFmeHhrZWRyb3R6cW11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MzM1NzQsImV4cCI6MjA3NTUwOTU3NH0.ItAWcNehzvrc7jHZqeOO2HaABAZ36eC64_Xq1TIB_Mk';
  const SUPER_ADMIN  = 'yyyjian96996@gmail.com'; // ä»…ç”¨äºæ˜¾ç¤ºâ€œåˆ é™¤â€æŒ‰é’®

  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  // ====== DOM å¼•ç”¨ ======
  const loginPage = document.getElementById('loginPage');
  const appPage   = document.getElementById('appPage');
  const loginBtn  = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');

  const saveBtn   = document.getElementById('saveBtn');
  const resetBtn  = document.getElementById('resetBtn');

  const nameInput  = document.getElementById('name');
  const phoneInput = document.getElementById('phone');
  const storeSel   = document.getElementById('store');
  const kissInput  = document.getElementById('kiss');
  const megaInput  = document.getElementById('mega');
  const pussyInput = document.getElementById('pussy');

  const tbody     = document.getElementById('tbody');
  const searchBox = document.getElementById('search');
  const langSwitch= document.getElementById('langSwitch');

  // ====== çŠ¶æ€ ======
  let currentUser = null;
  let isAdmin = false;
  let allRows = [];               // æœ€è¿‘ä¸€æ¬¡åŠ è½½çš„å®Œæ•´æ•°æ®
  let currentLang = 'zh';

  // ====== è¯­è¨€åˆ‡æ¢ï¼ˆä¸­æ–‡ / é©¬æ¥æ–‡ï¼‰ ======
  const langText = {
    zh: {
      title: "é¡¾å®¢ä¼šå‘˜è®°å½•",
      login: "ç™»å½•ç³»ç»Ÿ",
      loginHint: "æ²¡æœ‰è´¦å·ï¼Ÿè¯·è”ç³»ç®¡ç†å‘˜æ³¨å†Œ",
      save: "ä¿å­˜",
      clear: "æ¸…ç©º",
      logout: "é€€å‡º",
      list: "é¡¾å®¢åˆ—è¡¨",
      switch: "åˆ‡æ¢è‡³ Malay ğŸ‡²ğŸ‡¾"
    },
    ms: {
      title: "Rekod Keahlian Pelanggan",
      login: "Log Masuk Sistem",
      loginHint: "Tiada akaun? Sila hubungi pentadbir.",
      save: "Simpan",
      clear: "Kosongkan",
      logout: "Log Keluar",
      list: "Senarai Pelanggan",
      switch: "Tukar ke ä¸­æ–‡ ğŸ‡¨ğŸ‡³"
    }
  };

  function applyLang() {
    const t = langText[currentLang];
    const byId = (id, txt) => { const el = document.getElementById(id); if (el) el.innerText = txt; };
    byId("titleText",  t.title);
    byId("loginTitle", t.login);
    byId("loginHint",  t.loginHint);
    byId("saveBtn",    t.save);
    byId("resetBtn",   t.clear);
    byId("logoutBtn",  t.logout);
    byId("listTitle",  t.list);
    if (langSwitch) langSwitch.innerText = t.switch;
  }
  if (langSwitch) langSwitch.onclick = () => { currentLang = currentLang === 'zh' ? 'ms' : 'zh'; applyLang(); };

  // ====== ä¼šè¯è‡ªåŠ¨æ¢å¤ ======
  (async () => {
    const { data } = await supabase.auth.getSession();
    if (data.session?.user) {
      currentUser = data.session.user;
      isAdmin = (currentUser.email || '').toLowerCase() === SUPER_ADMIN.toLowerCase();
      showApp();
    } else {
      showLogin();
    }
  })();

  function showLogin() {
    applyLang();
    if (appPage)   appPage.classList.add('hidden');
    if (loginPage) loginPage.classList.remove('hidden');
  }
  function showApp() {
    applyLang();
    if (loginPage) loginPage.classList.add('hidden');
    if (appPage)   appPage.classList.remove('hidden');

    // è¡¨å¤´æ·»åŠ ã€Œæ“ä½œã€åˆ—ï¼ˆæ‰€æœ‰ç”¨æˆ·éƒ½æ˜¾ç¤ºä¸€æ¬¡ï¼‰
    const headRow =
      document.querySelector('#customerTable thead tr') ||
      document.querySelector('#table thead tr') ||
      document.querySelector('table thead tr');
    if (headRow && !headRow.querySelector('th.op')) {
      const th = document.createElement('th');
      th.className = 'op';
      th.textContent = 'æ“ä½œ';
      headRow.appendChild(th);
    }

    loadTable();
  }

  // ====== ç™»å½• / ç™»å‡º ======
  if (loginBtn) {
    loginBtn.onclick = async () => {
      const email = (document.getElementById('email').value || '').trim();
      const password = (document.getElementById('password').value || '').trim();
      if (!email || !password) return alert('è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç ï¼');
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) return alert('ç™»å½•å¤±è´¥ï¼š' + error.message);
      currentUser = data.user;
      isAdmin = (email || '').toLowerCase() === SUPER_ADMIN.toLowerCase();
      showApp();
    };
  }

  if (logoutBtn) {
    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
      currentUser = null;
      isAdmin = false;
      showLogin();
    };
  }

  // ====== è½½å…¥æ•°æ® ======
  async function loadTable() {
    const { data, error } = await supabase
      .from('customers')
      .select('*')
      .order('created', { ascending: false });
    if (error) return alert('åŠ è½½å¤±è´¥: ' + error.message);
    allRows = data || [];
    filterAndRender();
  }

  // ====== æœç´¢è¿‡æ»¤ï¼ˆå§“å/æ‰‹æœºå·ï¼›æ‰‹æœºå·ç”¨åŸå§‹å€¼åŒ¹é…ï¼Œæ¸²æŸ“æ—¶å†è„±æ•ï¼‰ ======
  function filterAndRender() {
    const q = (searchBox?.value || '').trim().toLowerCase();
    if (!q) return renderTable(allRows);
    const digits = q.replace(/\D+/g, '');
    const filtered = allRows.filter(r => {
      const nameHit  = (r.name || '').toLowerCase().includes(q);
      const phoneHit = digits ? String(r.phone || '').includes(digits) : false;
      return nameHit || phoneHit;
    });
    renderTable(filtered);
  }
  if (searchBox) searchBox.addEventListener('input', filterAndRender);

  // ====== æ¸²æŸ“è¡¨æ ¼ ======
  function renderTable(data) {
    if (!tbody) return;
    tbody.innerHTML = '';
    (data || []).forEach(row => {
      const tr = document.createElement('tr');

      // éç®¡ç†å‘˜ï¼šæ‰‹æœºå·åªæ˜¾ç¤ºå 5 ä½
      let displayPhone = String(row.phone || '');
      if (!isAdmin) {
        const last5 = displayPhone.slice(-5);
        displayPhone = '*****' + last5;
      }

      // æ“ä½œæŒ‰é’®ï¼šæ‰€æœ‰äººéƒ½æœ‰â€œç¼–è¾‘IDâ€ï¼›ç®¡ç†å‘˜é¢å¤–æœ‰â€œåˆ é™¤â€
      const actions = isAdmin
        ? `<button class="edit-btn" data-id="${row.id}">ç¼–è¾‘ID</button>
           <button class="danger del-btn" data-id="${row.id}">åˆ é™¤</button>`
        : `<button class="edit-btn" data-id="${row.id}">ç¼–è¾‘ID</button>`;

      tr.innerHTML = `
        <td>${row.name || ''}</td>
        <td>${displayPhone}</td>
        <td>${row.store || ''}</td>
        <td>${row.kiss_id || ''}</td>
        <td>${row.mega_id || ''}</td>
        <td>${row.pussy_id || ''}</td>
        <td>${actions}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ====== ä¿å­˜ï¼ˆä»»ä½•è´¦å·éƒ½å¯å†™å…¥ 3 ä¸ª IDï¼›name/phone åªåœ¨æ–°å¢æ—¶å½•å…¥ï¼‰ ======
  if (saveBtn) {
    saveBtn.onclick = async () => {
      const name  = nameInput?.value.trim();
      const phone = phoneInput?.value.trim();
      const store = storeSel?.value.trim();
      const kiss  = kissInput?.value.trim();
      const mega  = megaInput?.value.trim();
      const pussy = pussyInput?.value.trim();

      if (!name || !phone) return alert('å§“åä¸æ‰‹æœºå·ä¸ºå¿…å¡«é¡¹ï¼');

      const payload = {
        name, phone, store,
        kiss_id:  kiss || null,
        mega_id:  mega || null,
        pussy_id: pussy || null,
        created:  new Date().toISOString()
      };

      const { error } = await supabase.from('customers').insert([payload]);
      if (error) return alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);

      ['name','phone','kiss','mega','pussy'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      loadTable();
    };
  }

  if (resetBtn) {
    resetBtn.onclick = () => {
      ['name','phone','kiss','mega','pussy'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
    };
  }

  // ====== è¡¨æ ¼äº‹ä»¶ï¼šç¼–è¾‘ID / åˆ é™¤ ======
  if (tbody) {
    tbody.addEventListener('click', async (e) => {
      const edit = e.target.closest('.edit-btn');
      if (edit) {
        const id = edit.getAttribute('data-id');
        if (!id) return;

        const row = (allRows || []).find(r => String(r.id) === String(id)) || {};

        const kiss  = prompt('è¯·è¾“å…¥ KISS ID',  row.kiss_id  ?? '') ;
        if (kiss === null) return;  // å–æ¶ˆ
        const mega  = prompt('è¯·è¾“å…¥ MEGA ID',  row.mega_id  ?? '') ;
        if (mega === null) return;
        const pussy = prompt('è¯·è¾“å…¥ PUSSY ID', row.pussy_id ?? '') ;
        if (pussy === null) return;

        const payload = {
          kiss_id:  kiss  || null,
          mega_id:  mega  || null,
          pussy_id: pussy || null
        };

        const { error } = await supabase.from('customers').update(payload).eq('id', id);
        if (error) return alert('æ›´æ–°å¤±è´¥ï¼š' + error.message);
        loadTable();
        return;
      }

      const del = e.target.closest('.del-btn');
      if (del) {
        const id = del.getAttribute('data-id');
        if (!id) return;
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
        const { error } = await supabase.from('customers').delete().eq('id', id);
        if (error) return alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
        loadTable();
      }
    });
  }
</script>
</body>
</html>





