<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>é¡¾å®¢ä¼šå‘˜è®°å½• Â· Supabase ç‰ˆ</title>
  <style>
    :root{
      --bg:#0f172a;
      --panel:#111827;
      --muted:#1f2937;
      --text:#e5e7eb;
      --sub:#94a3b8;
      --accent:#22c55e;
      --accent-2:#3b82f6;
      --danger:#ef4444;
      --warn:#f59e0b;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:linear-gradient(180deg,#0b1220,#111827);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    header{position:sticky;top:0;background:rgba(15,23,42,.9);backdrop-filter:blur(6px);border-bottom:1px solid #1f2937;padding:10px 20px;display:flex;justify-content:space-between;align-items:center;z-index:10}
    h1{font-size:20px}
    button,select,input{font-family:inherit}
    button{cursor:pointer;border:none;border-radius:10px;padding:8px 14px;font-weight:600}
    button.primary{background:var(--accent);color:#001b0e}
    button.danger{background:var(--danger);color:#fff}
    button.secondary{background:var(--accent-2);color:#fff}
    main{max-width:1100px;margin:20px auto;padding:0 20px;display:grid;gap:20px}
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:16px;padding:20px;box-shadow:0 6px 20px rgba(0,0,0,.3)}
    label{font-size:13px;color:var(--sub);margin-bottom:5px;display:block}
    input,select{width:100%;padding:10px 12px;background:var(--muted);color:var(--text);border:1px solid #334155;border-radius:10px}
    .row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #1f2937;padding:10px;text-align:left}
    th{color:#cbd5e1}
    .hidden{display:none}
    #langSwitch{background:var(--muted);color:var(--text);border:1px solid #334155;border-radius:10px;padding:6px 10px;cursor:pointer}
    .loginBox{max-width:400px;margin:60px auto;background:var(--panel);border-radius:16px;padding:20px;border:1px solid #1f2937;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.3)}
    .loginBox input{margin-bottom:10px}
  </style>
</head>
<body>
  <header>
    <h1 id="titleText">é¡¾å®¢ä¼šå‘˜è®°å½•</h1>
    <button id="langSwitch">åˆ‡æ¢è‡³ Malay ğŸ‡²ğŸ‡¾</button>
  </header>

  <main id="loginPage">
    <div class="loginBox">
      <h2 id="loginTitle">ç™»å½•ç³»ç»Ÿ</h2>
      <input id="email" type="email" placeholder="é‚®ç®±" />
      <input id="password" type="password" placeholder="å¯†ç " />
      <button id="loginBtn" class="primary">ç™»å½•</button>
      <p style="color:var(--sub);margin-top:10px" id="loginHint">æ²¡æœ‰è´¦å·ï¼Ÿè¯·è”ç³»ç®¡ç†å‘˜æ³¨å†Œ</p>
    </div>
  </main>

  <main id="appPage" class="hidden">
    <section class="card">
      <h2 id="formTitle">æ–°å¢ / ç¼–è¾‘é¡¾å®¢</h2>
      <div class="row">
        <div><label>å§“å</label><input id="name"></div>
        <div><label>æ‰‹æœºå·</label><input id="phone"></div>
        <div><label>é—¨åº—</label>
          <select id="store">
            <option value="TP-KPIDH">TP-KPIDH</option>
            <option value="TP-TSP">TP-TSP</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div><label>KISS ID</label><input id="kiss"></div>
        <div><label>MEGA ID</label><input id="mega"></div>
        <div><label>PUSSY ID</label><input id="pussy"></div>
      </div>
      <div style="margin-top:12px">
        <button id="saveBtn" class="primary">ä¿å­˜</button>
        <button id="resetBtn" class="secondary">æ¸…ç©º</button>
      </div>
    </section>

    <section class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 id="listTitle">é¡¾å®¢åˆ—è¡¨</h2>
        <button id="logoutBtn" class="danger">é€€å‡º</button>
      </div>
      <input id="search" placeholder="æœç´¢å§“åæˆ–å·ç ..." style="margin:10px 0;width:100%;padding:8px">
      <div style="overflow:auto">
        <table id="customerTable">
          <thead>
            <tr>
              <th>å§“å</th>
              <th>æ‰‹æœºå·</th>
              <th>é—¨åº—</th>
              <th>KISS ID</th>
              <th>MEGA ID</th>
              <th>PUSSY ID</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

<script type="module">
  // ====== Supabase åˆå§‹åŒ– ======
  import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

  // âš ï¸ è¿™ä¸¤è¡Œç”¨ä½ çš„çœŸå®é¡¹ç›®é…ç½®ï¼ˆä¸‹é¢æ˜¯ä½ ä¹‹å‰ç»™æˆ‘çš„å€¼ï¼›å¦‚å·²æ”¹åŠ¨è¯·æ›¿æ¢ä¸ºä½ ç°åœ¨çš„ï¼‰
  const SUPABASE_URL = 'https://ozxwxzafxxkedrotzqmu.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im96eHd4emFmeHhrZWRyb3R6cW11Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MzM1NzQsImV4cCI6MjA3NTUwOTU3NH0.ItAWcNehzvrc7jHZqeOO2HaABAZ36eC64_Xq1TIB_Mk';
  const SUPER_ADMIN = 'yyyjian96996@gmail.com';

  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  // ====== DOM å¼•ç”¨ ======
  const loginPage = document.getElementById('loginPage');
  const appPage   = document.getElementById('appPage');
  const loginBtn  = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const tbody     = document.getElementById('tbody');
  const searchBox = document.getElementById('search');
  const langSwitch= document.getElementById('langSwitch');

  // ====== çŠ¶æ€ ======
  let currentUser = null;
  let isAdmin = false;
  let allRows = [];     // æœ€è¿‘ä¸€æ¬¡åŠ è½½çš„å®Œæ•´æ•°æ®
  let currentLang = 'zh';

  // ====== è¯­è¨€åˆ‡æ¢ï¼ˆä¸­ / é©¬ï¼‰ ======
  const langText = {
    zh: {
      title: "é¡¾å®¢ä¼šå‘˜è®°å½•",
      login: "ç™»å½•ç³»ç»Ÿ",
      loginHint: "æ²¡æœ‰è´¦å·ï¼Ÿè¯·è”ç³»ç®¡ç†å‘˜æ³¨å†Œ",
      save: "ä¿å­˜",
      clear: "æ¸…ç©º",
      logout: "é€€å‡º",
      list: "é¡¾å®¢åˆ—è¡¨",
      switch: "åˆ‡æ¢è‡³ Malay ğŸ‡²ğŸ‡¾"
    },
    ms: {
      title: "Rekod Keahlian Pelanggan",
      login: "Log Masuk Sistem",
      loginHint: "Tiada akaun? Sila hubungi pentadbir.",
      save: "Simpan",
      clear: "Kosongkan",
      logout: "Log Keluar",
      list: "Senarai Pelanggan",
      switch: "Tukar ke ä¸­æ–‡ ğŸ‡¨ğŸ‡³"
    }
  };

  function applyLang() {
    const t = langText[currentLang];
    document.getElementById("titleText").innerText   = t.title;
    document.getElementById("loginTitle").innerText  = t.login;
    document.getElementById("loginHint").innerText   = t.loginHint;
    document.getElementById("saveBtn").innerText     = t.save;
    document.getElementById("resetBtn").innerText    = t.clear;
    document.getElementById("logoutBtn").innerText   = t.logout;
    document.getElementById("listTitle").innerText   = t.list;
    langSwitch.innerText = t.switch;
  }
  langSwitch.onclick = () => { currentLang = currentLang === 'zh' ? 'ms' : 'zh'; applyLang(); }

  // ====== ä¼šè¯è‡ªåŠ¨æ¢å¤ ======
  (async () => {
    const { data } = await supabase.auth.getSession();
    if (data.session?.user) {
      currentUser = data.session.user;
      isAdmin = (currentUser.email || '').toLowerCase() === SUPER_ADMIN.toLowerCase();
      showApp();
    } else {
      showLogin();
    }
  })();

  function showLogin() {
    applyLang();
    appPage.classList.add('hidden');
    loginPage.classList.remove('hidden');
  }
  function showApp() {
    applyLang();
    loginPage.classList.add('hidden');
    appPage.classList.remove('hidden');
    // ç®¡ç†å‘˜ï¼šåœ¨è¡¨å¤´è¿½åŠ â€œæ“ä½œâ€åˆ—ï¼ˆåªåŠ ä¸€æ¬¡ï¼‰
    if (isAdmin) {
      const headRow = document.querySelector('#customerTable thead tr');
      if (headRow && !headRow.querySelector('th.op')) {
        const th = document.createElement('th');
        th.className = 'op';
        th.textContent = 'æ“ä½œ';
        headRow.appendChild(th);
      }
    }
    loadTable();
  }

  // ====== ç™»å½• / ç™»å‡º ======
  loginBtn.onclick = async () => {
    const email = (document.getElementById('email').value || '').trim();
    const password = (document.getElementById('password').value || '').trim();
    if (!email || !password) return alert('è¯·è¾“å…¥é‚®ç®±ä¸å¯†ç ï¼');
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) return alert('ç™»å½•å¤±è´¥ï¼š' + error.message);
    currentUser = data.user;
    isAdmin = (email || '').toLowerCase() === SUPER_ADMIN.toLowerCase();
    showApp();
  };

  logoutBtn.onclick = async () => {
    await supabase.auth.signOut();
    currentUser = null;
    isAdmin = false;
    showLogin();
  };

  // ====== è½½å…¥æ•°æ® ======
  async function loadTable() {
    const { data, error } = await supabase
      .from('customers')
      .select('*')
      .order('created', { ascending: false });
    if (error) return alert('åŠ è½½å¤±è´¥: ' + error.message);
    allRows = data || [];
    filterAndRender();
  }

  // ====== æœç´¢è¿‡æ»¤ï¼ˆå§“å/æ‰‹æœºå·ï¼›æ‰‹æœºå·ç”¨åŸå§‹å€¼åŒ¹é…ï¼Œæ¸²æŸ“æ—¶å†è„±æ•ï¼‰ ======
  function filterAndRender() {
    const q = (searchBox.value || '').trim().toLowerCase();
    if (!q) return renderTable(allRows);
    const digits = q.replace(/\D+/g, '');
    const filtered = allRows.filter(r => {
      const nameHit  = (r.name || '').toLowerCase().includes(q);
      const phoneHit = digits ? String(r.phone || '').includes(digits) : false;
      return nameHit || phoneHit;
    });
    renderTable(filtered);
  }
  searchBox.addEventListener('input', filterAndRender);

  // ====== æ¸²æŸ“è¡¨æ ¼ ======
  function renderTable(data) {
    tbody.innerHTML = '';
    (data || []).forEach(row => {
      const tr = document.createElement('tr');
      // éç®¡ç†å‘˜ï¼šæ‰‹æœºå·åªæ˜¾ç¤ºå 5 ä½
      let displayPhone = String(row.phone || '');
      if (!isAdmin) {
        const last5 = displayPhone.slice(-5);
        displayPhone = '*****' + last5;
      }
      tr.innerHTML = `
        <td>${row.name || ''}</td>
        <td>${displayPhone}</td>
        <td>${row.store || ''}</td>
        <td>${row.kiss_id || ''}</td>
        <td>${row.mega_id || ''}</td>
        <td>${row.pussy_id || ''}</td>
        ${isAdmin ? `<td><button class="danger del-btn" data-id="${row.id}">åˆ é™¤</button></td>` : ``}
      `;
      tbody.appendChild(tr);
    });
  }

  // ====== ä¿å­˜ï¼ˆä»»ä½•è´¦å·éƒ½å¯å†™å…¥ 3 ä¸ª IDï¼‰ ======
  document.getElementById('saveBtn').onclick = async () => {
    const name  = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const store = document.getElementById('store').value.trim();
    const kiss  = document.getElementById('kiss').value.trim();
    const mega  = document.getElementById('mega').value.trim();
    const pussy = document.getElementById('pussy').value.trim();
    if (!name || !phone) return alert('å§“åä¸æ‰‹æœºå·ä¸ºå¿…å¡«é¡¹ï¼');

    const payload = {
      name, phone, store,
      kiss_id:  kiss || null,
      mega_id:  mega || null,
      pussy_id: pussy || null,
      created:  new Date().toISOString()
    };

    const { error } = await supabase.from('customers').insert([payload]);
    if (error) return alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);

    ['name','phone','kiss','mega','pussy'].forEach(id => document.getElementById(id).value = '');
    loadTable();
  };

  document.getElementById('resetBtn').onclick = () => {
    ['name','phone','kiss','mega','pussy'].forEach(id => document.getElementById(id).value = '');
  };

  // ====== åˆ é™¤ï¼ˆä»…ç®¡ç†å‘˜ï¼‰ ======
  tbody.addEventListener('click', async (e) => {
    const btn = e.target.closest('.del-btn');
    if (!btn) return;
    const id = btn.getAttribute('data-id');
    if (!id) return;
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) return;
    const { error } = await supabase.from('customers').delete().eq('id', id);
    if (error) return alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
    loadTable();
  });
</script>
</body>
</html>




